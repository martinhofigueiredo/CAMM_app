<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video.js Player</title>
    <!-- Include Video.js CSS and JS -->
    <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet">
    <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
</head>
<body>
    <h1>Video.js Player</h1>

    <!-- Video.js player container -->
    <video id="videoPlayer" class="video-js vjs-default-skin" controls preload="auto" width="640" height="360">
        <source src="" type="application/x-mpegURL">
        Your browser does not support the video tag.
    </video>

    <div>Microphone Volume: <span id="volume">0</span></div>

    <script>
        const socket = io.connect(window.location.origin);
        const volumeDisplay = document.getElementById("volume");

        // Microphone volume handling
        async function startAudioVolumeMonitoring() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 256;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            function updateVolume() {
                analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                volumeDisplay.innerText = average.toFixed(2);
                socket.emit("volume", { volume: average.toFixed(2) });
                requestAnimationFrame(updateVolume);
            }

            updateVolume();
        }

        startAudioVolumeMonitoring();

        // Video.js player setup
        const player = videojs('videoPlayer');

        // Socket event to receive stream URL
        socket.on("stream-url", (data) => {
            const { url, type } = data; // "url" is the video stream URL, "type" can be "dash" or "hls"

            if (type === "hls") {
                player.src({
                    src: url,
                    type: "application/x-mpegURL",
                });
            } else if (type === "dash") {
                player.src({
                    src: url,
                    type: "application/dash+xml",
                });
            }

            player.play();
        });
    </script>
</body>
</html>
